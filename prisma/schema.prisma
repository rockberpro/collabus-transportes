generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["windows", "debian-openssl-3.0.x", "native"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id           String         @id @default(cuid())
  email        String         @unique
  password     String
  role         Role           @default(PASSAGEIRO)
  isActive     Boolean        @default(true)
  personId     String?        @unique
  companyId    String?
  avatarBase64 String?        @db.Text
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  tokens       Token[]
  routes       RouteDriver[]
  person       Person?        @relation(fields: [personId], references: [id])
  company      Company?       @relation(fields: [companyId], references: [id])

  @@map("users")
}

model Person {
  id        String    @id @default(cuid())
  firstName String
  lastName  String
  cpf       String?   @unique
  phone     String?
  address   String?
  birthDate DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  user      User?

  @@map("persons")
}

model Token {
  id        String    @id @default(cuid())
  token     String    @unique
  type      TokenType
  expiresAt DateTime
  usedAt    DateTime?
  userId    String
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("tokens")
}

enum Role {
  ADMINISTRADOR @map("administrador")
  PASSAGEIRO    @map("passageiro")
  MOTORISTA     @map("motorista")
  SUPERVISOR    @map("supervisor")
}

enum TokenType {
  EMAIL_VERIFICATION @map("email_verification")
  PASSWORD_RESET     @map("password_reset")
  ACCESS_TOKEN       @map("access_token")
  REFRESH_TOKEN      @map("refresh_token")
}

model Route {
  id          String         @id @default(cuid())
  code        String?        @unique
  origin      String
  destination String
  state       String
  city        String
  isActive    Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  schedules   Schedule[]
  vehicles    RouteVehicle[]
  drivers     RouteDriver[]

  @@map("routes")
}

model Schedule {
  id        String   @id @default(cuid())
  routeCode String
  state     String
  city      String
  times     Json
  routeId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  route     Route    @relation(fields: [routeId], references: [id], onDelete: Cascade)

  @@unique([routeCode, state, city])
  @@map("schedules")
}

model Company {
  id        String    @id @default(cuid())
  name      String    @unique
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  users     User[]
  vehicles  Vehicle[]

  @@map("companies")
}

model Vehicle {
  id        String         @id @default(cuid())
  plate     String         @unique
  brand     String
  model     String
  year      Int
  capacity  Int
  isActive  Boolean        @default(true)
  companyId String
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  company   Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  routes    RouteVehicle[]

  @@map("vehicles")
}

model RouteVehicle {
  id        String   @id @default(cuid())
  routeId   String
  vehicleId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  route     Route    @relation(fields: [routeId], references: [id], onDelete: Cascade)
  vehicle   Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@unique([routeId, vehicleId])
  @@map("route_vehicles")
}

model RouteDriver {
  id        String   @id @default(cuid())
  routeId   String
  driverId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  route     Route    @relation(fields: [routeId], references: [id], onDelete: Cascade)
  driver    User     @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@unique([routeId, driverId])
  @@map("route_drivers")
}
